#data availabe at NCBI GEO - GSE123778. The datafiles corresponding to the sample “GSM3511192” 
setwd("D:/Shainer et al data")
getwd()
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
library(sctransform)
drpineal.data <- Read10X(data.dir = "/Shainer et al data/gzfiles/")
drpineal <- CreateSeuratObject(counts = drpineal.data, project = "shainer.pineal", min.cells = 3, min.features = 200)
drpineal[["percent.mt"]] <- PercentageFeatureSet(drpineal, pattern = "^mt-")
VlnPlot(drpineal, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
drpineal <- subset(drpineal, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & nCount_RNA < 15000 &  percent.mt < 5)
all.genes <- rownames(drpineal)
drpineal<- SCTransform(drpineal, vars.to.regress = "percent.mt", verbose = FALSE)
top10.drpineal <- head(VariableFeatures(drpineal), 10)
plot1 <- VariableFeaturePlot(drpineal)
plot2 <- LabelPoints(plot = plot1, points = top10.drpineal, repel = TRUE)
drpineal <- RunPCA(drpineal, features = VariableFeatures(object = drpineal))
drpineal <- JackStraw(drpineal, num.replicate = 100)
drpineal <- ScoreJackStraw(drpineal, dims = 1:20)
JackStrawPlot(drpineal, dims = 1:15)
ElbowPlot(drpineal)
drpineal <- FindNeighbors(drpineal, dims = 1:5)
drpineal <- FindClusters(drpineal, resolution = 0.2)
drpineal <- RunUMAP(drpineal, dims = 1:5)
DimPlot(drpineal, reduction = "umap")
drpineal.markers <- FindAllMarkers(drpineal, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, test.use = "roc")
drpineal.markers %>%
  +     group_by(cluster) %>%
  +     slice_max(n = 2, order_by = avg_log2FC)
#cluster0.markers <- FindMarkers(drpineal, ident.1 = 0, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
#cluster1.markers <- FindMarkers(drpineal, ident.1 = 1, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
#cluster2.markers <- FindMarkers(drpineal, ident.1 = 2, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
#cluster3.markers <- FindMarkers(drpineal, ident.1 = 3, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)     
#cluster4.markers <- FindMarkers(drpineal, ident.1 = 4, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster0.markers <- FindMarkers(drpineal, ident.1 = 0, logfc.threshold = 0.25)
cluster1.markers <- FindMarkers(drpineal, ident.1 = 1, logfc.threshold = 0.25)
cluster2.markers <- FindMarkers(drpineal, ident.1 = 2, logfc.threshold = 0.25)
cluster3.markers <- FindMarkers(drpineal, ident.1 = 3, logfc.threshold = 0.25)     
cluster4.markers <- FindMarkers(drpineal, ident.1 = 4, logfc.threshold = 0.25)
#cluster1.markers <- FindMarkers(drpineal, ident.1 = 1, logfc.threshold = 0.25)
#Run after all seperate pdfs created 
new.cluster.ids <- c("Rod like photoreceptors", "RPE like Glial","Cone like photoreceptors","Muller glia like", "Microglia")
names(new.cluster.ids) <- levels(drpineal)
drpineal <- RenameIdents(drpineal, new.cluster.ids)
DimPlot(drpineal, reduction = "umap", label = FALSE, pt.size = 0.5) + NoLegend()
table(Idents(drpineal)) #to see how many cells are present in each cluster
DoHeatmap(drpineal, features = c("coch","exorh","gngt1","gnat1","gngt2a","gnat2","camk1gb","asip2b","rpe65a","rbp5","fabp7b","dkk3b","CNDP1","scg2b","cart3","pcp4a","apoc1","ccl34b.1","ccl35.1","srgn","plpp1a","ccl25b", "kiss1","adcyap1b","rgs16")) + NoLegend()
FeaturePlot(drpineal, features = c("coch", "asip2b"), blend = TRUE)
top20_degs_RPElikeglial <- cluster1.markers %>%
  +     top_n(n = 20, wt = avg_log2FC) %>%
  +     rownames()
DoHeatmap(drpineal, features = top20_degs_RPElikeglial,label = FALSE)
# Goenrich
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(c("clusterProfiler", "org.Dr.eg.db", "dplyr"))

# Load the libraries
library(clusterProfiler)
library(org.Dr.eg.db)
library(dplyr)
# Add rownames as a new column named 'gene'

cluster0.markers$gene <- rownames(cluster0.markers)
cluster1.markers$gene <- rownames(cluster1.markers)
cluster2.markers$gene <- rownames(cluster2.markers)
cluster3.markers$gene <- rownames(cluster3.markers)
cluster4.markers$gene <- rownames(cluster4.markers)

# View the updated dataframe
head(cluster1.markers)

# Extract gene symbols from cluster1.markers
Selected_drpineal.markers <- drpineal.markers %>% 
  filter(avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene)
Selected_cluster0.markers <- cluster0.markers %>% 
  filter(p_val_adj < 0.05,avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene) # Assuming 'gene' column contains gene names
Selected_cluster1.markers <- cluster1.markers %>% 
  filter(p_val_adj < 0.05,,avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene) # Assuming 'gene' column contains gene names
Selected_cluster2.markers <- cluster2.markers %>% 
  filter(p_val_adj < 0.05,avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene)
Selected_cluster3.markers <- cluster3.markers %>% 
  filter(p_val_adj < 0.05,avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene)

Selected_cluster4.markers <- cluster4.markers %>% 
  filter(p_val_adj < 0.05,avg_log2FC > 2) %>% # Apply significance threshold
  pull(gene)


# Perform GO term enrichment analysis
go_results <- enrichGO(gene         = gene_list,
                       OrgDb        = org.Dr.eg.db,
                       keyType      = "SYMBOL", # Adjust based on your gene IDs
                       ont          = "BP", # Can be "BP", "MF", or "CC"
                       pAdjustMethod = "BH", 
                       pvalueCutoff = 0.05,
                       qvalueCutoff = 0.05)

# View results
head(go_results)
# Barplot
barplot(go_results, showCategory = 20, title = "Top 20 Enriched GO Terms")

# Dotplot
dotplot(go_results, showCategory = 20, title = "Top 20 Enriched GO Terms")
# Install and load required package
if (!requireNamespace("clusterProfiler", quietly = TRUE)) {
  install.packages("clusterProfiler")
}
library(clusterProfiler)

# Assuming 'drpineal.markers$gene' contains the gene symbols
go_results <- bitr(Selected_drpineal.markers, 
                   fromType = "SYMBOL", 
                   toType = "GO", 
                   OrgDb = org.Dr.eg.db)
go_results_0 <- bitr(Selected_cluster0.markers, 
                     fromType = "SYMBOL", 
                     toType = "GO", 
                     OrgDb = org.Dr.eg.db)
go_results_1 <- bitr(Selected_cluster1.markers, 
                   fromType = "SYMBOL", 
                   toType = "GO", 
                   OrgDb = org.Dr.eg.db)
go_results_2 <- bitr(Selected_cluster2.markers, 
                     fromType = "SYMBOL", 
                     toType = "GO", 
                     OrgDb = org.Dr.eg.db)
go_results_3 <- bitr(Selected_cluster3.markers, 
                     fromType = "SYMBOL", 
                     toType = "GO", 
                     OrgDb = org.Dr.eg.db)
go_results_4 <- bitr(Selected_cluster4.markers, 
                     fromType = "SYMBOL", 
                     toType = "GO", 
                     OrgDb = org.Dr.eg.db)

# Filter for Biological Process (BP) level GO terms
bp_terms_0 <- go_results_0[go_results_0$ONTOLOGY == "BP", ]
bp_terms_1 <- go_results_1[go_results_0$ONTOLOGY == "BP", ]
bp_terms_2 <- go_results_2[go_results_0$ONTOLOGY == "BP", ]
bp_terms_3 <- go_results_3[go_results_0$ONTOLOGY == "BP", ]
bp_terms_4 <- go_results_4[go_results_0$ONTOLOGY == "BP", ]
bp_terms_drpineal <- go_results[go_results$ONTOLOGY == "BP", ]

# Install and load biomaRt
if (!requireNamespace("biomaRt", quietly = TRUE)) {
  install.packages("biomaRt")
}
library(biomaRt)

# Connect to the Ensembl BioMart database for Danio rerio (zebrafish)
mart <- useMart("ensembl", dataset = "drerio_gene_ensembl")

# Fetch all GO terms related to immune system processes
#immune_go <- getBM(attributes = c("go_id", "name_1006", "namespace_1003"), 
                   filters = "go_parent_term",
                   values = "GO:0002376", # Parent term: Immune system process
                   mart = mart)
#immune_go <- getBM(attributes = c("go_id", "name_1006", "namespace_1003"),
                   filters = "go_parent_term",
                   values = c("GO:0002376",  # Immune system process
                              "GO:0006955",  # Immune response
                              "GO:0002250",  # Adaptive immune response
                              "GO:0045087",  # Innate immune response
                              "GO:0006954",  # Inflammatory response
                              "GO:0002253",  # Activation of immune response
                              "GO:0050776",  # Regulation of immune response
                              "GO:0002682",  # Regulation of immune system process
                              "GO:0002684",  # Positive regulation of immune system process
                              "GO:0002683",  # Negative regulation of immune system process
                              "GO:0002443",  # Leukocyte mediated immunity
                              "GO:0002449",  # Lymphocyte mediated immunity
                              "GO:0002446",  # Neutrophil mediated immunity
                              "GO:0002444",  # Myeloid leukocyte mediated immunity
                              "GO:0002448",  # Effector immune response
                              "GO:0019882",  # Antigen processing and presentation
                              "GO:0002474",  # MHC class I pathway
                              "GO:0002478",  # MHC class II pathway
                              "GO:0001816",  # Cytokine production
                              "GO:0006952",  # Defense response
                              "GO:0008009",  # Chemokine activity
                              "GO:0002520",  # Immune system development
                              "GO:0002504",  # Antigen processing involved in immune response
                              "GO:0002252",  # Immune effector process
                              "GO:0002460"), # Somatic recombination-based adaptive response
                   mart = mart)
#alternative method 
# Load GO.db
library(GO.db)
library(AnnotationDbi)

# Recursive function using mget safely
get_all_children <- function(go_ids) {
  children_list <- mget(go_ids, GOBPCHILDREN, ifnotfound = NA)
  children <- unlist(children_list)
  children <- children[!is.na(children)]
  if (length(children) == 0) return(character(0))
  return(unique(c(children, get_all_children(children))))
}

# Start from immune system process
immune_parent <- "GO:0002376"
immune_terms <- unique(c(immune_parent, get_all_children(immune_parent)))

# Load biomaRt
library(biomaRt)

# Connect to Ensembl
ensembl <- useMart("ensembl", dataset = "drerio_gene_ensembl")  # Change species if needed

# Query genes annotated to immune-related GO terms
immune_gene_annotations <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name", "go_id", "name_1006", "namespace_1003"),
  filters = "go",
  values = immune_terms,
  mart = ensembl
)


# View immune-related GO terms
#head(immune_go)
# Ensure bp_terms and immune_go data are loaded correctly

# Filter bp_terms to include only immune-related GO terms
immune_related_genes_drpineal <- bp_terms_drpineal[bp_terms_drpineal$GO %in% immune_go$go_id, ]
#alterantive method
immune_related_genes_drpineal <- bp_terms_drpineal[bp_terms_drpineal$GO %in% immune_gene_annotations$go_id, ]
immune_related_genes_0 <- bp_terms_0[bp_terms_0$GO %in% immune_gene_annotations$go_id, ]
immune_related_genes_1 <- bp_terms_1[bp_terms_1$GO %in% immune_gene_annotations$go_id, ]
immune_related_genes_2 <- bp_terms_2[bp_terms_2$GO %in% immune_gene_annotations$go_id, ]
immune_related_genes_3 <- bp_terms_3[bp_terms_3$GO %in% immune_gene_annotations$go_id, ]
immune_related_genes_4<- bp_terms_4[bp_terms_4$GO %in% immune_gene_annotations$go_id, ]

unique_immune_genes_drpineal <- immune_related_genes_drpineal[!duplicated(immune_related_genes_drpineal$SYMBOL), ]
unique_immune_genes_0 <- immune_related_genes_0[!duplicated(immune_related_genes_0$SYMBOL), ]
unique_immune_genes_1 <- immune_related_genes_1[!duplicated(immune_related_genes_1$SYMBOL), ]
unique_immune_genes_2 <- immune_related_genes_2[!duplicated(immune_related_genes_2$SYMBOL), ]
unique_immune_genes_3 <- immune_related_genes_3[!duplicated(immune_related_genes_3$SYMBOL), ]
unique_immune_genes_4 <- immune_related_genes_4[!duplicated(immune_related_genes_4$SYMBOL), ]

Immune_genes__drpineal<-unique_immune_genes_drpineal$SYMBOL
Immune_genes_cluster0<-unique_immune_genes_0$SYMBOL
Immune_genes_cluster1<-unique_immune_genes_1$SYMBOL
Immune_genes_cluster2<-unique_immune_genes_2$SYMBOL
Immune_genes_cluster3<-unique_immune_genes_3$SYMBOL
Immune_genes_cluster4<-unique_immune_genes_4$SYMBOL

Immune_genes_heatmap_drpineal<- DoHeatmap(drpineal,features = Immune_genes__drpineal, label = FALSE)
num_genes_drpineal <- length(Immune_genes__drpineal)
pdf_height <- min(max(10, num_genes_drpineal * 0.2), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_drpineals.pdf", height = pdf_height, width = pdf_width)
print(Immune_genes_heatmap_drpineal)
dev.off()

Immune_genes_heatmap_rodlikephotoreceptors<- DoHeatmap(drpineal,features = Immune_genes_cluster0, label = FALSE)
num_genes_0 <- length(Immune_genes_cluster0)
pdf_height_0 <- min(max(10, num_genes_0 * 0.075), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_rodlikephotoreceptors.pdf", height = pdf_height_0, width = pdf_width)
print(Immune_genes_heatmap_rodlikephotoreceptors)
dev.off()

Immune_genes_heatmap_RPE_like_Glial<-DoHeatmap(drpineal,features = Immune_genes_cluster1, label = FALSE)
num_genes_1 <- length(Immune_genes_cluster1)
pdf_height_1 <- min(max(10, num_genes_1 * 0.075), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_RPE_like_Glial.pdf", height = pdf_height_1, width = pdf_width)
print(Immune_genes_heatmap_RPE_like_Glial)
dev.off()

Immune_genes_heatmap_Cone_like_photoreceptors <- DoHeatmap(drpineal,features = Immune_genes_cluster3, label = FALSE)
num_genes_2 <- length(Immune_genes_cluster2)
pdf_height_2 <- min(max(10, num_genes_2 * 0.075), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_Cone_like_photoreceptors.pdf", height = pdf_height_2, width = pdf_width)
print(Immune_genes_heatmap_Cone_like_photoreceptors)
dev.off()

Immune_genes_heatmap_Muller_glia_like <- DoHeatmap(drpineal,features = Immune_genes_cluster3, label = FALSE)
num_genes_3 <- length(Immune_genes_cluster3)
pdf_height_3 <- min(max(10, num_genes_3 * 0.075), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_Muller_glia_like.pdf", height = pdf_height_3, width = pdf_width)
print(Immune_genes_heatmap_Muller_glia_like)
dev.off()

Immune_genes_heatmap_Microglia <- DoHeatmap(drpineal,features = Immune_genes_cluster4, label = FALSE)
num_genes_4 <- length(Immune_genes_cluster4)
pdf_height_4 <- min(max(10, num_genes_4 * 0.075), 200)
pdf_width <- 10
pdf("immune genes heat map output/immune_heatmap_Microglia", height = pdf_height_4, width = pdf_width)
print(Immune_genes_heatmap_Microglia)
dev.off()

# View the results
head(immune_related_genes)
Immune_genes_drpineal_markers<-unique_immune_genes$SYMBOL
DoHeatmap(drpineal,features = Immune_genes_drpineal_markers, label = FALSE)
# Save the immune-related genes if needed
write.csv(immune_related_genes, "immune_related_genes.csv", row.names = FALSE)

# Ensure that the correct assay is set (e.g., RNA or SCT)
DefaultAssay(drpineal) <- "SCT"  # Replace with "RNA" if that's what you use

# Extract the normalized expression matrix
expr_matrix <- as.matrix(GetAssayData(drpineal, slot = "data"))

# Specify your gene of interest
gene_of_interest <- "coch"

# Check if the gene is present in the expression matrix
if (gene_of_interest %in% rownames(expr_matrix)) {
  
  # Extwriteact the expression values for the gene of interest
  gene_expression <- expr_matrix[gene_of_interest, ]
  
  # Compute correlations with all other genes
  correlations <- apply(expr_matrix, 1, function(x) cor(x, gene_expression, method = "pearson"))
  
  # Create a data frame with correlation values
  correlation_df <- data.frame(
    Gene = rownames(expr_matrix),
    Correlation = correlations
  )
  
  # Filter for highly correlated genes (e.g., absolute correlation > 0.7)
  highly_correlated_genes <- correlation_df[abs(correlation_df$Correlation) > 0.7, ]
  
  # Sort the results by absolute correlation values
  highly_correlated_genes <- highly_correlated_genes[order(-abs(highly_correlated_genes$Correlation)), ]
  
  # View the top results
  head(highly_correlated_genes)
  
} else {
  message("The gene of interest is not found in the expression matrix.")
}


top10_degs_RPElikeglial <- cluster1.markers %>%
  +     top_n(n = 10, wt = avg_log2FC) %>%
  +     rownames()
DoHeatmap(drpineal, features = top10_degs_RPElikeglial,label = FALSE)
